## 关于K8s的维护

### 1. node问题
#### 1.1 node重启
TODO
#### 1.2 node下线

### 2. 镜像管理
镜像存放位置取决于集群采用的容器运行时，首先配置crictl
```shell
# 若是docker作为运行时
crictl config runtime-endpoint unix:///var/run/cri-dockerd.sock

# 若是containerd作为运行时
crictl config runtime-endpoint unix:///var/run/containerd/containerd.sock
```
>crictl 是一个与容器运行时接口 (Container Runtime Interface，CRI) 兼容的命令行工具。
> CRI 是 Kubernetes 用于与容器运行时 (container runtime) 交互的标准接口。它允许 Kubernetes 与不同的容器运行时，如 Docker、containerd、CRI-O 等，进行通信并管理容器的生命周期。

查看集群的【当前节点】使用过的镜像：
```shell
# 如果在master节点执行，那么一般看不到业务pod使用的镜像
$ crictl images                                                            
IMAGE                                                             TAG                 IMAGE ID            SIZE
docker.io/calico/cni                                              v3.26.1             9dee260ef7f59       93.4MB
docker.io/calico/kube-controllers                                 v3.26.1             1919f2787fa70       32.8MB
docker.io/calico/node                                             v3.26.1             8065b798a4d67       86.6MB
registry.aliyuncs.com/google_containers/coredns                   v1.9.3              5185b96f0becf       14.8MB
registry.aliyuncs.com/google_containers/etcd                      3.5.6-0             fce326961ae2d       103MB
registry.aliyuncs.com/google_containers/kube-apiserver            v1.25.14            48f6f02f2e904       35.1MB
registry.aliyuncs.com/google_containers/kube-controller-manager   v1.25.14            2fdc9124e4ab3       31.9MB
registry.aliyuncs.com/google_containers/kube-proxy                v1.25.14            b2d7e01cd611a       20.5MB
registry.aliyuncs.com/google_containers/kube-scheduler            v1.25.14            62a4b43588914       16.2MB
registry.aliyuncs.com/google_containers/pause                     3.8                 4873874c08efc       311kB
registry.cn-hangzhou.aliyuncs.com/google_containers/pause         3.6                 6270bb605e12e       302kB
```

删除镜像
```shell
# 删除单个镜像
crictl rmi e6e09b2c69433
# 删除所有未使用到的镜像（用于释放磁盘空间）
crictl rmi --prune
```

### 2. Pod问题

### 2.1 Pod启动失败
现象：业务Pod一直处于`ContainerCreated`状态  
解决：describe pod的事件部分如下：
```shell
Events:
  Type     Reason                  Age                From               Message
  ----     ------                  ----               ----               -------
  Warning  FailedCreatePodSandBox  27h                kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox "8eb0d24a74f245b7cf603547f6b563984ea93396fd1640452c594f263bdd9ef0": plugin type="calico" failed (add): error getting ClusterInformation: connection is unauthorized: Unauthorized
  Normal   SandboxChanged          27h (x4 over 27h)  kubelet            Pod sandbox changed, it will be killed and re-created.
  Normal   Scheduled               46s                default-scheduler  Successfully assigned default/hellok8s-go-http-55cfd74847-w4bt4 to k8s-node1
```
查询：

- [K8S问题排查-升级K8S后apiserver的token超期问题](https://lyyao09.github.io/2023/05/14/k8s/K8S问题排查-升级K8S后apiserver的token超期问题/#more)
- [github issue](https://github.com/projectcalico/calico/issues/5712)

得知是calico pod使用的token过期，临时办法是delete calico pod，让它们重新创建，然后业务Pod就会正常了。

### 3. 清理资源

```shell
kubectl delete deployment,service --all
```