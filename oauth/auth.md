# 认证和鉴权

## 1. Oauth 2.0

### 1.1 为什么采用它？

大部分常规系统如ERP、OA、管理后台等一般仅采用简单的Token认证方案，大概流程如下：

1. 用户在网页或app上输入账密，并传输到服务器；
2. 服务器验证账密成功，将用户id、登录方式、登录时间等信息使用**md5/sha**等摘要方式（可填充一个固定的salt
   key）生成一个Token和生成Token的用户登录信息返还给客户端；
   同时将登录信息写入缓存（以uid+登录方式为key，value可以简单设置为1），设置一定过期时间；
3. 客户端在后续请求中携带登录信息和Token（一般放在header中），服务器收到请求后使用收到的登录信息以相同方式再次进行摘要计算得到一个Token2，对比收到的Token是否一致，
   若一致说明Token正确，然后再通过uid+登录方式检查缓存中是否存在对应key，若存在说明Token未过期；

> 1. Token验证通过时，还可以对Token进行自动续期；
>2. JWT就是这个原理，本质上是应用了数字签名技术；

这种Token方式可以满足常规使用，但是在需要接入第三方授权访问时就捉襟见肘了（如果确定以后也不需要，那可以不使用 OAuth2.0 ）。

当我们需要接入第三方授权访问时（假如我是微信公司，豆瓣用户想要使用微信登录），不可能让用户在豆瓣网页/app上输入微信账密，然后传输给我们服务器进行认证，
这样就将用户密码直接暴露给了第三方，**完全无法保证用户信息安全**。

这时候OAuth 2.0 的好处就体现出来了，下面大致讲一下OAuth2.0 常用的授权码方式（第三方使用） 和 密码式（自己的系统前端使用）。

### 1.2 授权码方式（Authorization Code）：

这是OAuth 2.0中最常用的授权流程之一，用于安全地授权第三方APP访问用户的资源。在这个流程中，用户的凭证（用户名和密码）不会暴露给第三方APP。流程如下：

- 用户访问第三方APP，并选择使用OAuth登录。
- 第三方APP将用户重定向到授权服务器（通常是身份提供者）。
- 用户在授权服务器上进行身份验证（通常是通过用户名和密码）。
- 一旦用户成功登录，授权服务器将生成一个授权码（authorization-code），并将其发送回第三方APP的回调URL。
- 第三方APP使用授权码向授权服务器请求访问令牌，以及刷新令牌。
- 授权服务器验证授权码的有效性，并向第三方APP颁发访问令牌以及刷新令牌。
- 第三方APP使用访问令牌来访问受保护的资源，而不是用户的凭证。
- 当访问令牌过期时，第三方APP需要通过刷新令牌获取新的访问令牌。
- 当刷新令牌也过期时，第三方APP应要求用户重新登录。

> 1. 授权码是一个有效期很短（通常是几分钟到几十分钟）、一次性使用的凭据，仅用于获取访问令牌（Access Token）
>2. 访问令牌的有效期相比刷新令牌较短，一般是几个小时（如2小时，7小时）
>3. 刷新令牌的有效期一般是几天（如3天，7天）

需要注意的是，授权码方式通常包括一个**前置流程**，大致如下：

- **第三方APP注册**：第三方APP需要先在授权系统中进行注册（或登记），这通常包括提供应用程序的名称、描述、重定向URI（用于接收授权码的URI）等信息。
- **用户授权设置**：用户登录到授权系统，并在授权系统中设置或配置哪些属性或权限可以被第三方APP访问。用户可以明确选择允许或拒绝第三方APP对其资源的访问。
- **发放应用程序凭证**：一旦第三方APP完成注册并经过用户的授权设置，授权系统会向该应用程序发放一组凭证，通常包括应用程序的标识符（通常称为app
  ID或client ID）和应用程序的秘钥（通常称为client secret）。
- **使用授权码方式进行授权**：一旦第三方APP拥有了这些凭证，它可以使用授权码方式进行授权，包括将用户重定向到授权服务器以获取授权码，然后交换授权码以获取访问令牌和刷新令牌。

这个前置流程的目的是确保用户能够明确地控制哪些第三方APP可以访问他们的资源，并为每个应用程序授权的属性或权限进行配置，这有助于保护用户的隐私和安全。
**用户可以随时在系统中撤销对第三方APP的授权**。

### 1.3 密码式（Resource Owner Password Credentials）

这也是OAuth 2.0中的一种授权流程，允许用户将其用户名和密码直接提供给客户端应用程序，以获取访问令牌，而不涉及授权码的交换。流程如下：

- 用户提供其用户名和密码给客户端应用程序。
- 客户端应用程序将用户提供的用户名和密码直接发送到授权服务器。
- 授权服务器验证用户的凭证（用户名和密码）的有效性。
- 如果用户的凭证有效，授权服务器颁发一个访问令牌给客户端应用程序。
- 客户端应用程序可以使用访问令牌来访问受保护的资源。

需要注意的是，密码式授权允许用户直接在认证端输入账密，所以一般只应用在完全受信任的自己的系统前端应用中（而不是第三方应用）。

#### 1.4 小结

OAuth2.0 是一种授权访问的规范和协议，并不限制具体实现方式，在生成（访问和刷新）令牌时可以使用JWT或其他安全方式。