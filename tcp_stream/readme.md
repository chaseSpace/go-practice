## TCP流协议设计与实现（Go）

### 1. 流协议设计

下面是一个简洁但结构完备的TCP流协议设计，它具有优雅性和可升级性：

1. 协议头部：协议头部包含了以下信息：
   - 协议版本号：用于指定协议的版本号。
   - 数据长度：用于指定数据段的长度。
   - 校验和：用于校验数据段是否正确。

2. 数据段：数据段包含了实际传输的数据。

3. 协议尾部：协议尾部包含了以下信息：
   - 结束标志：用于指示数据传输结束。

这个TCP流协议设计简单、优雅，并且具有可扩展性和可维护性。

### 1.1 协议头部
```shell
|(版本号)1byte|(数据长度)4byte|(校验和)2byte|
```

- 版本号：1byte，使用单字节中的1个bit来即可存储
- 数据长度：4byte，最多表示十进制的4294967295
- 校验和：2byte，具体细节参见下一小节

### 1.2 校验和计算

具体实现请参阅：[cal_checksum.go](./cal_checksum.go)

在TCP流协议设计中，**校验和**的计算方法如下：

1. 使用一个4字节变量（uint32）存储TCP报文组中的所有16位字（包括首部和数据部分）相加的和。

2. 如果和的高16位不为0，则将其与低16位相加，直到高16位为0为止。

3. 将最终得到的和按位取反，得到校验和。

4. 将计算得到的校验和填充到TCP报文组首部中的校验和字段中。

这样计算出来的校验和可以用于检测TCP报文组在传输过程中是否被修改或损坏。如果接收方计算出来的校验和与发送方填充的校验和不一致，则说明TCP报文组已经被修改或损坏，需要丢弃。

### 1.3 数据段
裸数据内容。

### 1.4 小结
关于将一段字节流解析为一个完整tcp报文段的代码参见 [tcp_pack.go](./tcp_pack.go)文件中的 `parsePack()` 方法。